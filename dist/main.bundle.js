(()=>{"use strict";class t{constructor(t,s){this.x=t,this.y=s}clone(){return new t(this.x,this.y)}static add(s,i){return"number"==typeof i?new t(s.x+i,s.y+i):new t(s.x+i.x,s.y+i.y)}static equal(t,s){return t.x===s.x&&t.y===s.y}static sub(s,i){return"number"==typeof i?new t(s.x-i,s.y-i):new t(s.x-i.x,s.y-i.y)}static product(s,i){return new t(s.x*i,s.y*i)}static dot(t,s){return t.x*s.x+t.y*s.y}static div(s,i){return new t(s.x/i,s.y/i)}static clampNumber(t,s,i){return t<s?s:t>i?i:t}static clamp(s,i,e){return new t(t.clampNumber(s.x,i.x,e.x),t.clampNumber(s.y,i.y,e.y))}static minus(s){return new t(-s.x,-s.y)}equal(t){return this.x===t.x&&this.y===t.y}normalize(){const t=this.distance();this.x/=t,this.y/=t,(isNaN(this.x)||isNaN(this.y))&&console.error("Alert!!!!")}lenSqr(){return this.x*this.x+this.y*this.y}distance(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}}var s;!function(t){t[t.Circle=0]="Circle",t[t.AABB=1]="AABB"}(s||(s={}));class i{constructor(t){this.shapeType=s.Circle,this.density=1,this.radius=t}computeMass(){return Math.PI*Math.pow(this.radius,2)*this.density}getRadius(){return this.radius}}class e{constructor(t,i){this.shapeType=s.AABB,this.density=3,this.max=i.clone(),this.min=t.clone()}getCenter(){return t.div(t.add(this.min,this.max),2)}computeMass(){const s=t.sub(this.max,this.min);return s.x*s.y*this.density}}class n{constructor(s,i,e){this.velocity=new t(0,0),this.static_fraction=.1,this.dynamic_fraction=.05,this.restitution=1,this.force=new t(0,0),this.shape=s,this.position=i,this.restitution=e,this.mass=s.computeMass(),this.inverse_mass=0!==this.mass?1/this.mass:0,console.log(`inverse mass = ${this.inverse_mass}`)}applyForce(s){this.force=t.add(this.force,s)}applyImpulse(s){console.log(`this.iverse_mass = ${this.inverse_mass}`),console.log("product = "+s.x*this.inverse_mass),this.velocity=t.add(this.velocity,t.product(s,this.inverse_mass))}makeStatic(){this.mass=0,this.inverse_mass=0}renderCircle(t,s){t.beginPath(),t.fillStyle="rgb(235, 235, 235)",t.arc(this.position.x,this.position.y,s.getRadius(),0,2*Math.PI),t.fill()}renderAABB(s,i){s.beginPath(),s.fillStyle="rgb(72, 77, 116)";const e=t.div(t.sub(i.max,i.min),2),n=t.sub(this.position,e);s.fillRect(n.x,n.y,2*e.x,2*e.y)}render(t){switch(this.shape.shapeType){case s.Circle:this.renderCircle(t,this.shape);break;case s.AABB:this.renderAABB(t,this.shape)}}}const o=new Map([[s.Circle,new Map([[s.Circle,function(s,i,e){const n=i.shape,o=e.shape,a=t.sub(e.position,i.position),r=n.getRadius()+o.getRadius(),h=a.lenSqr();if(h>=r*r)return;const c=Math.sqrt(h);0===c?(s.penetration=n.getRadius(),s.normal=new t(1,0),s.contacts.push(i.position)):(s.penetration=r-c,s.normal=t.div(a,c),s.contacts.push(t.add(t.product(s.normal,n.getRadius()),i.position)))}],[s.AABB,function(s,i,e){r(s,e,i),s.normal=t.minus(s.normal)}]])],[s.AABB,new Map([[s.Circle,r],[s.AABB,function(s,i,e){const n=i.shape,o=e.shape,a=t.sub(e.position,i.position);let r=(n.max.x-n.min.x)/2,h=(o.max.x-o.min.x)/2;const c=r+h-Math.abs(a.x);if(c>0){r=(n.max.y-n.min.y)/2,h=(o.max.y-o.min.y)/2;const i=r+h-Math.abs(a.y);i>0&&(c<i?(a.x<0?s.normal=new t(-1,0):s.normal=new t(1,0),s.penetration=c):(a.y<0?s.normal=new t(0,-1):s.normal=new t(0,1),s.penetration=i),s.contacts.push(new t(0,0)))}}]])]]);class a{constructor(s,i){this.normal=new t(0,1),this.penetration=0,this.e=0,this.df=0,this.sf=0,this.contacts=[],this.a=s,this.b=i}solve(){var t;const s=null===(t=o.get(this.a.shape.shapeType))||void 0===t?void 0:t.get(this.b.shape.shapeType);if(!s)throw Error("Invalid shape type");s(this,this.a,this.b)}initialize(){this.e=Math.min(this.a.restitution,this.b.restitution),this.sf=Math.sqrt(this.a.static_fraction*this.a.static_fraction+this.b.static_fraction*this.b.static_fraction),this.df=Math.sqrt(this.a.dynamic_fraction*this.a.dynamic_fraction+this.b.dynamic_fraction*this.b.dynamic_fraction)}applyImpulse(){if(Math.abs(this.a.inverse_mass+this.b.inverse_mass)<1e-5)return void this.infiniteMassCorrection();const s=t.dot(t.sub(this.b.velocity,this.a.velocity),this.normal);if(s>0)return;const i=this.a.inverse_mass+this.b.inverse_mass;let e=-(1+this.e)*s;e/=i;const n=t.product(this.normal,e);this.a.applyImpulse(t.minus(n)),this.b.applyImpulse(n);const o=t.sub(this.b.velocity,this.a.velocity),a=t.sub(o,t.product(this.normal,t.dot(o,this.normal)));if(Math.abs(a.lenSqr()-0)<=1e-4)return;a.normalize();let r,h=-t.dot(o,a);h/=i,Math.abs(h-0)<1e-5||(console.log(`computed jt = ${h}, j = ${e}`),r=Math.abs(h)<e*this.sf?t.product(a,h):t.product(a,-e*this.df),console.log(`tangent_impulse = (${r.x}, ${r.y})`),this.a.applyImpulse(t.minus(r)),this.b.applyImpulse(r))}positionalCorrection(){}infiniteMassCorrection(){this.a.velocity=new t(0,0),this.b.velocity=new t(0,0)}}function r(s,i,e){const n=i.shape,o=e.shape;let a=t.sub(e.position,i.position);const r=t.div(t.sub(n.max,n.min),2),h=t.clamp(a,t.minus(r),r),c=t.add(i.position,h);a=t.sub(c,e.position),a.lenSqr()<o.getRadius()*o.getRadius()&&(s.contacts.push(c),t.equal(e.position,c)&&console.error("Equal sub"),s.normal=t.sub(e.position,c),s.normal.normalize(),s.penetration=0)}const h=document.querySelector(".scene"),c=h.getContext("2d");h.width=480,h.height=800;const l=new class{constructor(s,i){this.bodies=[],this.contacts=[],this.gravityScale=10,this.gravity=new t(0,10*this.gravityScale),this.dt=s,this.iterations=i}getBodies(){return this.bodies}step(){this.contacts.length=0;for(let t=0;t<this.bodies.length;++t){const s=this.bodies[t];for(let i=t+1;i<this.bodies.length;++i){const t=this.bodies[i];if(0===s.inverse_mass&&0===t.inverse_mass)continue;const e=new a(s,t);e.solve(),e.contacts.length>0&&this.contacts.push(e)}}for(let t=0;t<this.bodies.length;++t)this.integrateForces(this.bodies[t],this.dt);for(let t=0;t<this.contacts.length;++t)this.contacts[t].initialize();for(let t=0;t<this.iterations;++t)for(let t=0;t<this.contacts.length;++t)this.contacts[t].applyImpulse();for(const t of this.bodies)this.integrateVelocity(t,this.dt);for(const t of this.contacts)t.positionalCorrection();for(const s of this.bodies)s.force=new t(0,0)}add(t){this.bodies.push(t)}getContacts(){return this.contacts}integrateForces(s,i){0!==s.inverse_mass&&(s.velocity=t.add(s.velocity,t.product(t.add(t.product(s.force,s.inverse_mass),this.gravity),i/2)))}integrateVelocity(s,i){0!==s.inverse_mass&&(s.position=t.add(s.position,t.product(s.velocity,i)),this.integrateForces(s,i))}}(1/60,20);!function(){const s=new e(new t(0,0),new t(h.width,10)),i=new n(s,s.getCenter(),.5);i.makeStatic(),l.add(i);const o=new e(new t(0,h.height-20),new t(h.width,h.height)),a=new n(o,o.getCenter(),.5);a.makeStatic(),l.add(a);const r=new e(new t(0,10),new t(10,h.height-20)),c=new n(r,r.getCenter(),.5);c.makeStatic(),l.add(c);const u=new e(new t(h.width-10,10),new t(h.width,h.height-20)),d=new n(u,u.getCenter(),.5);d.makeStatic(),l.add(d)}();const u=()=>{c.fillStyle="rgb(45, 64, 108)",c.fillRect(0,0,h.width,h.height),l.step();for(const t of l.getBodies())t.render(c);requestAnimationFrame(u)};u(),h.addEventListener("mousedown",(s=>{if(0===s.button){const e=h.getBoundingClientRect(),o=new t(s.clientX-e.left,s.clientY-e.top);l.add(new n(new i(30),o,1))}else if(2===s.button){const i=h.getBoundingClientRect(),o=new t(s.clientX-i.left,s.clientY-i.top),a=new e(new t(0,0),new t(60,60));l.add(new n(a,o,1))}}))})();
//# sourceMappingURL=main.bundle.js.map